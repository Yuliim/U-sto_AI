import os
import pandas as pd
import numpy as np
from faker import Faker
import random
from datetime import datetime, timedelta


BASE_DIR = os.path.dirname(os.path.abspath(__file__))
SAVE_DIR = os.path.join(BASE_DIR, "data_lifecycle")
os.makedirs(SAVE_DIR, exist_ok=True) # í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
# ---------------------------------------------------------
# 0. ì„¤ì • ë° ì´ˆê¸°í™”
# ---------------------------------------------------------
fake = Faker('ko_KR')  # í•œêµ­ì–´ ë”ë¯¸ ë°ì´í„° ìƒì„±ê¸°
TOTAL_COUNT = 5000     # ìƒì„±í•  ë°ì´í„° ê°œìˆ˜ (ì•½ 5000ê±´)

# ìŠ¹ì¸ ìƒíƒœ ë¹„ìœ¨ ì„¤ì • (í™•ì • 97%, ëŒ€ê¸° 2%, ë°˜ë ¤ 1%)
APPROVAL_RATIOS = [0.97, 0.02, 0.01]
APPROVAL_STATUSES = ['í™•ì •', 'ëŒ€ê¸°', 'ë°˜ë ¤']
REMARK_TEMPLATES_BY_CLASS = {
    # IT / ì „ì‚° ì¥ë¹„
    "ë…¸íŠ¸ë¶ì»´í“¨í„°": [
        "AI ì‹¤ìŠµ ìˆ˜ì—…ìš© ë…¸íŠ¸ë¶",
        "ì „ì‚° ì‹¤ìŠµì‹¤ ê³µìš© ì¥ë¹„",
        "êµìˆ˜Â·ì—°êµ¬ì› ì—…ë¬´ìš©",
        "í•™ê³¼ ê³µìš© ì „ì‚° ìì‚°"
    ],
    "ë°ìŠ¤í¬í†±ì»´í“¨í„°": [
        "ì „ì‚° ì‹¤ìŠµì‹¤ ê³ ì •í˜• PC",
        "ì—°êµ¬ì‹¤ ë¶„ì„ ì—…ë¬´ìš©",
        "í–‰ì • ì—…ë¬´ìš© ë°ìŠ¤í¬í†±"
    ],
    "ì•¡ì •ëª¨ë‹ˆí„°": [
        "ì „ì‚° ì‹¤ìŠµì‹¤ ë³´ì¡° ëª¨ë‹ˆí„°",
        "ì‚¬ë¬´í™˜ê²½ ê°œì„ ìš©",
        "ì—°êµ¬ì‹¤ ë‹¤ì¤‘ í™”ë©´ êµ¬ì„±ìš©"
    ],
    "í—ˆë¸Œ": [
        "ì „ì‚°ë§ í™•ì¶©ìš©",
        "ì‹¤ìŠµì‹¤ ë„¤íŠ¸ì›Œí¬ êµ¬ì„±ìš©"
    ],
    "ë¼ìš°í„°": [
        "ì‹¤ìŠµì‹¤ ë„¤íŠ¸ì›Œí¬ ì¦ì„¤",
        "í•™ê³¼ ì „ì‚°ë§ ê³ ë„í™”"
    ],
    "í•˜ë“œë””ìŠ¤í¬ë“œë¼ì´ë¸Œ": [
        "ì—°êµ¬ ë°ì´í„° ì €ì¥ìš©",
        "ì„œë²„ ì¦ì„¤ìš© ìŠ¤í† ë¦¬ì§€"
    ],
    "í”Œë˜ì‹œë©”ëª¨ë¦¬ì €ì¥ì¥ì¹˜": [
        "êµìœ¡ ìë£Œ ë°°í¬ìš©",
        "ë°±ì—… ë§¤ì²´"
    ],
    "ìŠ¤ìºë„ˆ": [
        "í–‰ì • ë¬¸ì„œ ì „ì‚°í™”",
        "ìë£Œ ë””ì§€í„¸ ì•„ì¹´ì´ë¹™"
    ],
    "ë ˆì´ì €í”„ë¦°í„°": [
        "í–‰ì • ë¬¸ì„œ ì¶œë ¥ìš©",
        "í•™ê³¼ ê³µìš© í”„ë¦°í„°"
    ],

    # ê°€êµ¬ / ì§‘ê¸°
    "ì±…ìƒ": [
        "ê°•ì˜ì‹¤ í™˜ê²½ ê°œì„ ",
        "ì—°êµ¬ì‹¤ ì§‘ê¸° êµì²´",
        "ì‹ ê·œ ì—°êµ¬ì‹¤ êµ¬ì¶•"
    ],
    "ì‘ì—…ìš©ì˜ì": [
        "ì‚¬ë¬´í™˜ê²½ ê°œì„ ",
        "ë…¸í›„ ì§‘ê¸° êµì²´"
    ],
    "ì±…ê±¸ìƒ": [
        "ê°•ì˜ì‹¤ ì§‘ê¸° êµì²´",
        "ë…¸í›„ ì±…ê±¸ìƒ êµì²´"
    ],
    "ì„œëí˜•ìˆ˜ë‚©ì¥": [
        "ì—°êµ¬ì‹¤ ë¬¸ì„œ ë³´ê´€ìš©",
        "í–‰ì • ìë£Œ ìˆ˜ë‚©ìš©"
    ],

    # êµìœ¡ ê¸°ìì¬
    "ì¹ íŒë³´ì¡°ì¥": [
        "ê°•ì˜ì‹¤ ê¸°ìì¬ ë³´ê°•",
        "ë…¸í›„ ê¸°ìì¬ êµì²´"
    ],
    "ì¸í„°ë™í‹°ë¸Œí™”ì´íŠ¸ë³´ë“œ": [
        "ìŠ¤ë§ˆíŠ¸ ê°•ì˜ì‹¤ êµ¬ì¶•",
        "ë””ì§€í„¸ ê°•ì˜ í™˜ê²½ ê°œì„ "
    ],
}

# ---------------------------------------------------------
# 1. ë§ˆìŠ¤í„° ë°ì´í„° ì •ì˜ (Master Data)
# ---------------------------------------------------------
# 1-1. G2B í’ˆëª© ë§ˆìŠ¤í„° (17ê°œ í‘œì¤€ í’ˆëª©)
# êµ¬ì¡°: [ë¬¼í’ˆë¶„ë¥˜ì½”ë“œ(8), ë¬¼í’ˆì‹ë³„ì½”ë“œ(8), í’ˆëª©ëª…, ë¶„ë¥˜ëª…, ë‚´ìš©ì—°ìˆ˜, í‰ê· ë‹¨ê°€(ì›)]
G2B_MASTER_DATA = [
    # IT ê¸°ê¸°
    ("43211503", "26103121",
     "ë…¸íŠ¸ë¶ì»´í“¨í„°, Asus, (CN)B3605CCA-CP0004X, Intel Core Ultra 7 255H(2GHz), ì•¡ì„¸ì‚¬ë¦¬ë³„ë„",
     "ë…¸íŠ¸ë¶ì»´í“¨í„°", 6, 1800000),

    ("43211507", "26111329",
     "ë°ìŠ¤í¬í†±ì»´í“¨í„°, í•œì„±ì»´í“¨í„°, K15-5B71651V0, (ë‚´)Ultra 5 235(3.4GHz)/(ì™¸)Ultra 5 225(3.3GHz)",
     "ë°ìŠ¤í¬í†±ì»´í“¨í„°", 5, 1200000),

    ("43211902", "26108810",
     "ì•¡ì •ëª¨ë‹ˆí„°, ì•ŒíŒŒìŠ¤ìº”ë””ìŠ¤í”Œë ˆì´, (CN)16T20, 39.5cm",
     "ì•¡ì •ëª¨ë‹ˆí„°", 5, 250000),

    ("43222610", "25578661",
     "í—ˆë¸Œ, Belkin, (US)INC002, 7port",
     "í—ˆë¸Œ", 5, 90000),

    ("45111601", "25414806",
     "í¬ì¸í„°, ì´ˆì´ìŠ¤í…Œí¬ë†€ë¡œì§€, XPM180Y, ìœ íš¨ê±°ë¦¬ 50m",
     "í¬ì¸í„°", 5, 60000),

    ("43201803", "26048280",
     "í•˜ë“œë””ìŠ¤í¬ë“œë¼ì´ë¸Œ, Lenovo, (CN)4XB7A88027, 22TB",
     "í•˜ë“œë””ìŠ¤í¬ë“œë¼ì´ë¸Œ", 6, 750000),

    ("43222609", "26066170",
     "ë¼ìš°í„°, Netgear, (US)PR60X",
     "ë¼ìš°í„°", 6, 550000),

    ("43202005", "25605835",
     "í”Œë˜ì‹œë©”ëª¨ë¦¬ì €ì¥ì¥ì¹˜, Sandisk, (CN)EXTREME PRO SDXC, 64GB",
     "í”Œë˜ì‹œë©”ëª¨ë¦¬ì €ì¥ì¥ì¹˜", 4, 40000),

    ("43211711", "26101603",
     "ìŠ¤ìºë„ˆ, Kodak alaris, (CN)E1040, 600dpi",
     "ìŠ¤ìºë„ˆ", 6, 900000),

    ("44101601", "26057578",
     "ì¢…ì´ì ˆë‹¨ê¸°, Siser north america, (CN)Romeo, 920Ã—180Ã—200mm",
     "ì¢…ì´ì ˆë‹¨ê¸°", 8, 650000),

    # ê°€êµ¬ ë° ìˆ˜ë‚©
    ("56101703", "26113315",
     "ì±…ìƒ, ì‹ í¥, SH-DEAGB11, 1180Ã—780Ã—600~1130mm, 1ì¸ìš©",
     "ì±…ìƒ", 10, 350000),

    ("56112102", "26112769",
     "ì‘ì—…ìš©ì˜ì, ì—ì½”ìš°ë“œ, ECO-L003H, 610Ã—680Ã—1185mm",
     "ì‘ì—…ìš©ì˜ì", 10, 220000),

    ("56112108", "24928465",
     "ì±…ê±¸ìƒ, ì˜ìê³µì¥ í”ŒëŸ¬ìŠ¤, PLU-PL01, 575Ã—700Ã—830mm",
     "ì±…ê±¸ìƒ", 10, 180000),

    ("56101597", "25964887",
     "ì„œëí˜•ìˆ˜ë‚©ì¥, ë¼ì˜¨ì‹œìŠ¤í…œê°€êµ¬, D-400-60-2, 500Ã—400Ã—558mm",
     "ì„œëí˜•ìˆ˜ë‚©ì¥", 10, 200000),

    # êµìœ¡ìš© ë³´ì¡°ì¥Â·ì „ìì¹ íŒÂ·í”„ë¦°í„°
    ("56121798", "25656485",
     "ì¹ íŒë³´ì¡°ì¥, ì •ìš´ì‹œìŠ¤í…œ, JWBB18212, (ë¶€í’ˆ)ì „ìì¹ íŒê±°ì¹˜íŒ, 1800Ã—235Ã—1200mm",
     "ì¹ íŒë³´ì¡°ì¥", 10, 800000),

    ("44111911", "26082440",
     "ì¸í„°ë™í‹°ë¸Œí™”ì´íŠ¸ë³´ë“œ, ë³´ì„±ì „ì, BSI-P24K, 59.94cm, ì „ììœ ë„ë°©ì‹/ì „ìíœ/ì „ìêµíƒí˜•",
     "ì¸í„°ë™í‹°ë¸Œí™”ì´íŠ¸ë³´ë“œ", 7, 2981000),

    ("43212105", "25911926",
     "ë ˆì´ì €í”„ë¦°í„°, Ricoh, (CN)P 310, A4/í‘ë°±/32ppm",
     "ë ˆì´ì €í”„ë¦°í„°", 5, 350000),
]


# 1-2. ë¶€ì„œ ë§ˆìŠ¤í„° (ì¡°ì§ë„)
DEPT_MASTER_DATA = [
    ("C354", "ì†Œí”„íŠ¸ì›¨ì–´ìœµí•©ëŒ€í•™RCí–‰ì •íŒ€(ERICA)"),
    ("C352", "ê³µí•™ëŒ€í•™RCí–‰ì •íŒ€(ERICA)"),
    ("C364", "ê²½ìƒëŒ€í•™RCí–‰ì •íŒ€(ERICA)"),
    ("C360", "ê¸€ë¡œë²Œë¬¸í™”í†µìƒëŒ€í•™RCí–‰ì •íŒ€(ERICA)"),
    ("A351", "ì‹œì„¤íŒ€(ERICA)"),
    ("A320", "í•™ìƒì§€ì›íŒ€(ERICA)"),
]
# ---------------------------------------------------------
# 2. ë°ì´í„° ìƒì„± ë¡œì§ (Phase 1)
# ---------------------------------------------------------
acquisition_list = []

print(f"ğŸš€ [Phase 1] ë¬¼í’ˆ ì·¨ë“ ë°ì´í„° {TOTAL_COUNT}ê±´ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤...")

# [ìˆ˜ì •] ê¸°ì¤€ì¼ì (Today)ë¥¼ datetime ê°ì²´ë¡œ ìƒì„± (ì‹œê°„ì€ 00:00:00)
now = datetime.now()
today = datetime(now.year, now.month, now.day)

for i in range(TOTAL_COUNT):
    # 1) ê¸°ë³¸ ì •ë³´ ì„ íƒ
    g2b_item = random.choice(G2B_MASTER_DATA)
    dept = random.choice(DEPT_MASTER_DATA)
    
    # G2B ì •ë³´ ì–¸íŒ¨í‚¹
    class_code, id_code, item_name, class_name, life_years, base_price = g2b_item
    g2b_full_code = class_code + id_code # 16ìë¦¬ ëª©ë¡ë²ˆí˜¸
    
    # 2) ìŠ¹ì¸ ìƒíƒœ ê²°ì • (89:10:1)
    approval_status = np.random.choice(APPROVAL_STATUSES, p=APPROVAL_RATIOS)
    
    # 3) ë‚ ì§œ ìƒì„± ë¡œì§
    # ê¸°ì¤€: 2015-01-01 ~ í˜„ì¬
    start_date_range = datetime(2015, 1, 1)
    
    # 'ëŒ€ê¸°' ìƒíƒœëŠ” ìµœê·¼(2024ë…„ 10ì›” ì´í›„)ì— ëª°ë ¤ìˆë„ë¡ ì„¤ì •
    if approval_status == 'ëŒ€ê¸°':
        wait_start = datetime(2024, 10, 1)
        temp_date = fake.date_between(start_date=wait_start, end_date=today)
    else:
        temp_date = fake.date_between(start_date=start_date_range, end_date=today)
    
    # [ìˆ˜ì •] ë‚´ë¶€ ê³„ì‚°ìš© ë³€ìˆ˜ëŠ” ë¬´ì¡°ê±´ datetime ê°ì²´ë¡œ ë³€í™˜
    acq_date = datetime(temp_date.year, temp_date.month, temp_date.day)

    # 4) ì •ë¦¬ì¼ì ìƒì„±
    # í™•ì •: ì·¨ë“ì¼ + (3ì¼ ~2ì£¼)
    # ëŒ€ê¸°/ë°˜ë ¤: NULL (None)
    clear_date = None
    if approval_status == 'í™•ì •':
        random_days = random.randint(3, 14)
        clear_date = (acq_date + timedelta(days=random_days))
        # ì •ë¦¬ì¼ìëŠ” í˜„ì¬ ë‚ ì§œë¥¼ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ ì œí•œ
        if clear_date > today:
            clear_date = today
    
    # 5) ìˆ˜ëŸ‰ ë° ê¸ˆì•¡ ìƒì„±
    # ì·¨ë“ ë‹¨ê³„ì—ì„œëŠ” 'ë¬¶ìŒ'ìœ¼ë¡œ ë“¤ì–´ì˜´ (ìˆ˜ëŸ‰ Nê°œ ê°€ëŠ¥)
    # PC/ë…¸íŠ¸ë¶ì€ ë³´í†µ 1~10ëŒ€, ì±…ìƒì€ 10~50ëŒ€ ë“± í’ˆëª©ë³„ ì°¨ì´ ë°˜ì˜
    if "ì±…ìƒ" in item_name or "ì˜ì" in item_name:
        quantity = random.randint(5, 50)
    else:
        quantity = random.randint(1, 10)
        
    # ì·¨ë“ê¸ˆì•¡ = (ë‹¨ê°€ * ìˆ˜ëŸ‰) + ëœë¤ ë…¸ì´ì¦ˆ(ì˜µì…˜ê°€ ë“±)
    unit_price = int(base_price * random.uniform(0.9, 1.1)) # ë‹¨ê°€ Â±10% ë³€ë™
    total_amount = unit_price * quantity
    total_amount = (total_amount // 1000) * 1000 # 1000ì› ë‹¨ìœ„ ì ˆì‚­
    
    # 6) ê¸°íƒ€ ì†ì„± (ì·¨ë“ì •ë¦¬êµ¬ë¶„)
    acq_method = np.random.choice(
        ['ìì²´êµ¬ì…', 'ìì²´ì œì‘', 'ê¸°ì¦'],
        p=[0.95, 0.02, 0.03]
    )
    # ë¹„ê³  ìƒì„±
    remark = ""
    if approval_status == 'ë°˜ë ¤':
        remark = "ì˜ˆì‚° ì´ˆê³¼ë¡œ ì¸í•œ ë°˜ë ¤"
    elif random.random() < 0.1:  # 10% í™•ë¥ ë¡œ ë¹„ê³  ìƒì„±
        # ë¬¼í’ˆ ë¶„ë¥˜ì— ë§ëŠ” ë¹„ê³  í…œí”Œë¦¿ ì„ íƒ
        candidates = REMARK_TEMPLATES_BY_CLASS.get(class_name, [])
        if candidates:
            remark = random.choice(candidates)

    # [ìˆ˜ì •] ì €ì¥ ì‹œì ì— ë¬¸ìì—´ ë³€í™˜
    acq_date_str = acq_date.strftime('%Y-%m-%d')
    clear_date_str = clear_date.strftime('%Y-%m-%d') if clear_date else ""

    # 7) ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ (ë§¤ë‰´ì–¼ ì†ì„± ë§¤í•‘)
    row = {
        # ì‹ë³„ ì •ë³´
        'G2B_ëª©ë¡ë²ˆí˜¸': g2b_full_code,
        'G2B_ëª©ë¡ëª…': item_name,
        # G2B ìƒì„¸ (ì¡°íšŒìš©)
        'ë¬¼í’ˆë¶„ë¥˜ì½”ë“œ': class_code,
        'ë¬¼í’ˆë¶„ë¥˜ëª…': class_name,
        'ë¬¼í’ˆì‹ë³„ì½”ë“œ': id_code,
        'ë¬¼í’ˆí’ˆëª©ëª…': item_name, 
        
        # ì·¨ë“ ì •ë³´
        'ì·¨ë“ì¼ì': acq_date_str,
        'ì·¨ë“ê¸ˆì•¡': total_amount,
        'ì •ë¦¬ì¼ì': clear_date_str,
        'ì·¨ë“ì •ë¦¬êµ¬ë¶„': acq_method,
        
        # ê´€ë¦¬ ì •ë³´
        'ìš´ìš©ë¶€ì„œ': dept[1],
        'ìš´ìš©ë¶€ì„œì½”ë“œ': dept[0], # ë§¤ë‰´ì–¼ìƒ ê°™ì€ ê°’
        'ìš´ìš©ìƒíƒœ': 'ì·¨ë“', # ì·¨ë“ ëŒ€ì¥ ìƒì—ì„œëŠ” ì´ˆê¸°ê°’ 'ì·¨ë“'
        'ë‚´ìš©ì—°ìˆ˜': life_years,
        'ìˆ˜ëŸ‰': quantity,
        'ìŠ¹ì¸ìƒíƒœ': approval_status,
        'ë¹„ê³ ': remark
    }
    acquisition_list.append(row)

# DataFrame ë³€í™˜
df_acquisition = pd.DataFrame(acquisition_list)
# ---------------------------------------------------------
# 3. ê²°ê³¼ ì €ì¥ (CSV Export)
# ---------------------------------------------------------

# [03-01] ë¬¼í’ˆ ì·¨ë“ ëŒ€ì¥ ëª©ë¡ (Main Output)
# í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì¶”ì¶œí•˜ì—¬ ì €ì¥
cols_acquisition = [
    'G2B_ëª©ë¡ë²ˆí˜¸', 'G2B_ëª©ë¡ëª…', 'ì·¨ë“ì¼ì', 'ì·¨ë“ê¸ˆì•¡', 'ì •ë¦¬ì¼ì', 
    'ìš´ìš©ë¶€ì„œ', 'ìš´ìš©ìƒíƒœ', 'ë‚´ìš©ì—°ìˆ˜', 'ìˆ˜ëŸ‰', 'ìŠ¹ì¸ìƒíƒœ', 
    'ì·¨ë“ì •ë¦¬êµ¬ë¶„', 'ìš´ìš©ë¶€ì„œì½”ë“œ', 'ë¹„ê³ '
]
df_acquisition[cols_acquisition].to_csv(os.path.join(SAVE_DIR, '03_01_acquisition_master.csv'), index=False, encoding='utf-8-sig')

# [03-02] G2B ëª©ë¡ ì¡°íšŒìš© (Popup Output)
# ë¶„ë¥˜ ëª©ë¡ (ì¤‘ë³µ ì œê±°)
df_class = df_acquisition[['ë¬¼í’ˆë¶„ë¥˜ì½”ë“œ', 'ë¬¼í’ˆë¶„ë¥˜ëª…']].drop_duplicates()
df_class.to_csv(os.path.join(SAVE_DIR, '03_02_g2b_class_list.csv'), index=False, encoding='utf-8-sig')

# í’ˆëª© ëª©ë¡ (ì¤‘ë³µ ì œê±°)
df_item = df_acquisition[['ë¬¼í’ˆì‹ë³„ì½”ë“œ', 'ë¬¼í’ˆí’ˆëª©ëª…', 'ë¬¼í’ˆë¶„ë¥˜ì½”ë“œ']].drop_duplicates()
df_item.to_csv(os.path.join(SAVE_DIR, '03_02_g2b_item_list.csv'), index=False, encoding='utf-8-sig')

print("âœ… [Phase 1] ë°ì´í„° ìƒì„± ì™„ë£Œ!")
print(f"   - ì´ {len(df_acquisition)}ê±´ì˜ ì·¨ë“ ë°ì´í„°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
print("   - ì €ì¥ íŒŒì¼: 03_01_acquisition_master.csv, 03_02_g2b_class_list.csv, 03_02_g2b_item_list.csv")
print("   - ìŠ¹ì¸ ìƒíƒœ ë¶„í¬:")
print(df_acquisition['ìŠ¹ì¸ìƒíƒœ'].value_counts())